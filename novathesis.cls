%!TEX root=template.tex
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% novathesis.cls
%% NOVA thesis document class
%%
%% This work is licensed under the
%% The LaTeX project public license (LPPL), version 1.3c
%% To view a copy of this license, visit
%% https://www.latex-project.org/lppl/lppl-1-3c/
%%
%% Version 2022-12-25 [6.10.17]
%% Departamento de Informática (www.di.fct.unl.pt)
%% Faculdade de Ciências e Tecnologia (www.fct.unl.pt)
%% Universidade NOVA de Lisboa (www.unl.pt)
%%
%% BUGS and SUGGESTIONS: please submit an issue at the project web page
%%      at: https://github.com/joaomlourenco/novathesis/
%%
%% HELP: please DO NOT SEND ME EMAILS about LaTeX or the NOVAthesis template
%%       please ask for help at GitHub Discussions page at
%%          https://github.com/joaomlourenco/novathesis/discussions
%%      or at the NOVAthesis facebook group at
%%          https://www.facebook.com/groups/novathesis
%%
%% AUTHOR @github:
%%      - joaomlourenco
%%
%% CONTRIBUTORS @github:
%%      https://github.com/joaomlourenco/novathesis/wiki#help-with-the-project-patches-and-new-features
%%
%% DONATIONS:
%%      If you think this template really helped you while writing your thesis, then
%%          1. Go to the project web page and giv it a star (on the top-right)
%%          2. Make a small donation using the URL below
%%                    https://www.paypal.com/donate/?hosted_button_id=8WA8FRVMB78W8
%%             We will keep a list thanking to all the identified donors that identify
%%             themselves in the “Add special instructions to the seller:” box.
%%
%% CITATION:
%%      If you use this template, please be kind and cite it in your bibliography:
%%           “João M. Lourenço, The NOVAthesis \LaTeX\ Template User’s Manual,
%%            NOVA University Lisbon, 2021,
%%            https://github.com/joaomlourenco/novathesis/raw/master/template.pdf.”
%%      The BibTeX entry is already in the exxample “bibliography.bib” file:
%%           @Manual{novathesis-manual,
%%              title       ={{The NOVAthesis \LaTeX\ Template User's Manual}},
%%              author      ={João M. Lourenço},
%%              organization={NOVA University Lisbon},
%%              year        ={2021},
%%              url         ={https://github.com/joaomlourenco/novathesis/raw/master/template.pdf},
%%           }
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING
%%% WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING
%%%
%%%   You SHOULD NOT change this file (you are playing with fire!)
%%%
%%% WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING
%%% WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}[2019-10-01]
\ProvidesClass{novathesis}[2022-12-25 novathesis template]


%============================================================
% Save these definitions asap, to be used later in the “\annex” command,
% because "\@Roman" and "\Roman" were failing with pdflatex 
% when loading the "greek" language (and LGR font encofing)
%============================================================
\let\oldRoman=\Roman
\let\old@Roman=\@Roman

%============================================================
%  MEMOIR CUSTOMIZATION / OPTIONS
%      Please open and edit the appropriate
%       configuration file “Config/0_memoir.tex”
%============================================================
\newcommand*{\ntmemoirsetup}[1]{%
		\PassOptionsToClass{#1}{memoir}%
}
\input{Config/0_memoir}

% --------------------------------------------------------
% LOAD MAIN CLASS AND ADDITIONAL PACKAGES
% \undef{\stockwidth}
% \undef{\stockheight}
\LoadClass{memoir}
\OnehalfSpacing% One-and-half spacing



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% SOME ESSENTIAL PACKAGES
%%    Others will be loaded later, in the file “packages.tex”
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[table,svgnames]{xcolor}%
% \RequirePackage{tabularray}
% \UseTblrLibrary{booktabs}


\ifdefined\NewDocumentCommand\else\RequirePackage{xparse}\fi   % load xparse if necessary
\RequirePackage{xfor}
\RequirePackage{iftex}
\RequirePackage{etoolbox}
\RequirePackage{xstring}
\RequirePackage{NOVAthesisFiles/options2}
\RequirePackage{NOVAthesisFiles/memory2}
\RequirePackage{NOVAthesisFiles/nt-version}

%%%%% Configure Graphics
\RequirePackage[nobeamer]{graphbox}% improved version of "graphicx"
\graphicspath{{Chapters/Figures/}}
\DeclareGraphicsExtensions{.pdf,.png,.jpg,.tif}
\providecommand*\appendtographicspath[1]{\xappto\Ginput@path{#1}}
\providecommand*\prependtographicspath[1]{\xpreto\Ginput@path{#1}}

%%%%% Options to sans serif fonts (will be loaded later)
\PassOptionsToPackage{scaled=1}{inter}%
\PassOptionsToPackage{scaled=0.95}{helvet}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% CHECK IF USING LUALATEX OR XELATEX
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \newif\ifxetexorluatex
% \begingroup\catcode94=7 \catcode0=9% ASCII 94 is ^
% \def\empty{}\def\next{^^^^0000}\expandafter\endgroup
% \ifx\next\empty\xetexorluatextrue\else\xetexorluatexfalse\fi
%
% \newcommand{\ifxeorlua}[2]{\ifxetexorluatex#1\else#2\fi}

\newcommand{\ifxeorlua}{\ifboolexpr{bool{luatex} or bool{xetex}}}
% \ifdef{\iftutex}{
		\newcommand{\ifxetexorluatex}{\iftutex}
% }{
%   \newif\ifxetexorluatex
%   \begingroup\catcode94=7 \catcode0=9% ASCII 94 is ^
%   \def\empty{}\def\next{^^^^0000}\expandafter\endgroup
%   \ifx\next\empty\xetexorluatextrue\else\xetexorluatexfalse\fi
% }


% \ifxetexorluatex  % xelatex or lualatex
% \else% pdflatex
%   %%%%% Configure font encoding
%   \RequirePackage[T1]{fontenc}    % Use new T1 fonts
%   %%%%% Configure input encoding
%   \RequirePackage[utf8]{inputenc}    % Format for the input file(s), see the "enc" option
% \fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% GENERAL PURPOSE MACROS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% --------------------------------------------------------
% The NOVAthesis logo
\ifdef{\iftutex}{
  \newcommand{\novathesis}
      {\includegraphics[height=1.1\fontcharht\font`A,vshift=-0.35pt]{NOVAthesisFiles/Images/novathesis-text}}
}{
  \newcommand{\novathesis}{\textsl{novathesis}}
}

% --------------------------------------------------------
% Define something (except counters) if undefined
\newcommand*{\defifundef}[2]{\ifundef{#1}{#2{#1}}{}}

% --------------------------------------------------------
% Variant of \@for with an optional final argument, that is 
% executed iif the loop is not interrupted
\def\ntforbreak{\@endfortrue}
\long\def\ntfor#1:=#2\do#3{\@ifnextchar[{\ntfor@i#1:=#2\do#3}{\ntfor@i#1:=#2\do#3[]}}
\long\def\ntfor@i#1:=#2\do#3[#4]{%
  \@for#1:={#2}\do{\xdef#1{#1}#3}%
  \if@endfor\else#4\fi
}

% --------------------------------------------------------
% Print string between <...>
\newcommand*{\embrace}[1]{$\langle$#1$\rangle$}

% --------------------------------------------------------
% Search if a data/memory is defined and returns value
\def\datamatch#1#2(#3){%
  % #1 = macro to set
  % #2 = data@memory
  % #3 = list of values
  % Search and match first value from the list, error if no match is found
  \datamatchtf{#1}{#2}(#3){}{\ClassError{novathesis}{Could not find “#2” defined with any of “(#3)”!}{}}%
}
\def\datamatchtf#1#2(#3)#4#5{%
	% #1 = macro to set
	% #2 = data@memory
	% #3 = list of values
	% #4 = true branch
	% #5 = false branch
	% Search and match first value from the list, true (found) and not true (not found) branches
	% \typeout{#2(#3)}%
	\ifdatadefinedor{\@match}{#2}(#3)%
		{\protect\xdef#1{\csuse{the#2}(\@match)}#4}%
		{\protect\xdef#1{}#5}%
}

% --------------------------------------------------------
% Check if a font file exists
\newcommand*{\ntcheckfont}[2]{%
	\IfFileExists{NOVAthesisFiles/FontStyles/Fonts/#1}{}%
		{\ClassError{novathesis}{Missing font “#1”! Please download from: “#2” and copy it to “NOVAthesisFiles/FontStyles/Fonts/#1”}{Please download from: “#2” and copy it to “NOVAthesisFiles/FontStyles/Fonts/#1”}}%
}


% --------------------------------------------------------
% Load and Helvetica-like font as the default SF font
\newcommand*{\LoadHelveticaLikeFont}{%
	\IfFileExists{inter.sty}%
		{\RequirePackage[scaled=1]{inter}}%
	{\IfFileExists{helvet.sty}%
		{\RequirePackage[scaled=0.95]{helvet}}%
	{\IfFileExists{gillius2.sty}%
		{\RequirePackage{gillius2}}%
		{\ClassWarning{novathesis}{Could not find a suitable Sans Serif font… using the default!}}}}%
}

% --------------------------------------------------------
% Trim spaces around argument
\ExplSyntaxOn
\cs_new_eq:NN \trimspaces \tl_trim_spaces:n
\ExplSyntaxOff

% --------------------------------------------------------
% Input the first file from the list (if any)
% #1 = file name
% #2 = list of directories
% #3 = code if succeed [OPTIONAL]
% #4 = code if fails [OPTIONAL]
\def\@nt@InputIfFileExists#1#2{%
  % \typeout{IIFE 1=[#1] 2=[#2]}\aaaa
  \@ifnextchar[{\@nt@InputIfFileExists@i{#1}#2}{\@nt@InputIfFileExists@i{#1}#2[]}%
}
\def\@nt@InputIfFileExists@i#1#2[#3]{%
  % \typeout{IIFE 1=[#1] 2=[#2] 3=[#3]}\aaaa
  \@ifnextchar[{\@nt@InputIfFileExists@ii{#1}#2[#3]}{\@nt@InputIfFileExists@ii{#1}#2[#3][]}%
}
\def\@nt@InputIfFileExists@ii#1#2[#3][#4]{
  % \typeout{IIFE 1=[#1] 2=[#2] 3=[#3] 4=[#4]}\aaaa
  \ntfor\dir:=#2\do{\IfFileExists{\dir#1}{\input{\dir#1}#3\ntforbreak}{}}[#4]%
}

% ][]{\ntfor\arg:=#3\do{\@nt@InputIfFileExists@i{#2}{\arg}}[#1]}
% \newcommand{\@nt@InputIfFileExists@i}[2]{\IfFileExists{#2#1}{\input{#2#1}\ntforbreak}{}}


\options{/@nt/.new family,
	langsshort/.new list={en, pt, fr, it, de, es, gr},
	currentlang/.new choice={en, pt, fr, it, de, es, gr},
	langshorttolong/.new choice={en=english, pt=portuges, fr=french, it=italian, de=german, es=spanish, gr=greek},
	fontenc/.new choice={en=T1, pt=T1, fr=T1, it=T1, de=T1, es=T1, gr=LGR},
	biblatex/.new list,
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% MANAGE FOLDERS PER CLASS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\options{/@nt/folders/.new choice={
	bib=Bibliography, 
	copyright=., 
	statement=., 
	dedicatory=Chapters, 
	acknowledgements=Chapters, 
	quote=Chapters, 
	abstract=Chapters, 
	glossaries=Chapters, 
	chapter=Chapters, 
	appendix=Chapters, 
	annex=Chapters,
	cover=Chapters, 
}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% MANAGE DOCUMENT CLASSES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\options{/@nt/document/.cd,
	 docclass/.new choice={phd=phd, phdprop=phd, phdplan=phd, msc=msc, mscplan=msc, bsc=bsc, plain=plain},
	 docmain/.new list={phd, msc, bsc, plain},
}

% --------------------------------------------------------
% Check if the document is of a specific class, i.e., bsc, msc, phd or main
\newcommand{\ifdocclass}[1]{\ifoptionequal{/@nt/document/docclass}{#1}}
\newcommand{\ifmaindoc}{\ifoptioncontains{/@nt/document/docmain}{\option{/novathesis/docdegree}}}
\newcommand{\ifphddoc}{\ifdocclass{phd}}
\newcommand{\ifmscdoc}{\ifdocclass{msc}}
\newcommand{\ifbscdoc}{\ifdocclass{bsc}}
\newcommand{\ifplaindoc}{\ifdocclass{plain}}

\newcommand{\ifdocstatus}[1]{\ifoptionequal{/novathesis/docstatus}{#1}}
\newcommand{\ifdocfinal}{\ifdocstatus{final}}
\newcommand{\ifdocprovisional}{\ifdocstatus{provisional}}
\newcommand{\ifdocworking}{\ifdocstatus{working}}
\newcommand{\ifdocunset}{\ifdocstatus{unset}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% MANAGE PERSON LISTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\ntaddperson#1(#2,#3)#4{%
	% syntax: \ntaddperson{class}[key,gender]{filename}
	% #1=adviser | committee
	% #2={a,c}            {c,r,a,m,g}
	%     a=adviser        c=chair
	%     c=coadviser      r=rapporteur/referee
	%                      a=adviser
	%                      ca=adviser
	%                      m=other members
	%                      g=guests
	% #3={m,f}
	% #4={person name, position, etc}
	\StrCut{#4}{,}\@nt@personname\@nt@dummy%was xStrCut
	\options{/@nt/#1/#2/name/.expanded/.cpush={\@nt@personname}}%
	\options{/@nt/#1/#2/full/.expanded/.cpush={#4}}%
	\options{/@nt/#1/#2/gender/.cpush={#3}}%
	% \typeout{NTADD [/@nt/#1/#2/name=\@nt@personname]}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% MANAGE FILE LISTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\ntaddfile}[1]{%
	% syntax: \ntaddfile{class}[key]{filename}
	%         #1=file family (quote, abstract, chapter, etc)
	%         #2=[file lang] (OPTIONAL)
	%         #3=filename
	\@nt@addtolist{file}{#1}%
}

\newcommand*{\@nt@addtolist}[2]{%
	% syntax: \ntaddto{type}{class}[key]{filename}
	%         #1 ={file, person}
	%         #2=family {quote, abstract, chapter, etc} or {author, adviser, committee}
	%         #3=[file lang] (OPTIONAL)
	%         #4=filename
	\@ifnextchar[{\@nt@addtolist@iv[#1]#2}{\@nt@addtolist@iv[#1]#2[VAL]}%
}

\def\@nt@addtolist@iv[#1]#2[#3]#4{%
	% syntax: \@ntaddfile@iii{type}{class}[key]{filename}
	%         #1 ={file, person}
	%         #2=file family (quote, abstract, chapter, etc)
	%         #3=optional file lang
	%         #4=filename
	% \typeout{NT addtolist [#1] [#2] [#3] [#4]}%
	\StrLeft{#4}{1}[\@nt@firstchar]%
	\IfStrEqCase{\@nt@firstchar}{%
		{/}{\xdef\@nt@filewithpath{#4}}%
		{.}{\xdef\@nt@filewithpath{#4}}%
	}[%
		\options{/@nt/folders=#2}%
		\xdef\@nt@filewithpath{\option{/@nt/folders}/#4}%
	]%
	\options{/@nt/#1/#2/#3/.expanded/.cpush={\@nt@filewithpath}}%
}

\newcommand*{\@nt@foralllist}[3]{%
	% #1={file, person}
	% #2=file family (quote, abstract, chapter, etc)
	% #3=macro to be applied, which will receive the item from the list
	\optionlistdo{/@nt/#1/#2}{#3{##1}}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Multilingual support
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\ntselectlang}[1]{%
	% #1=lang {pt, en, fr, it}
	\options{/@nt/currentlang=#1}%
	\options{/@nt/langshorttolong=#1}%
	\expandafter\selectlanguage\expandafter{\expanded{\option{/@nt/langshorttolong}}}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ASSOCARRAY
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\initmemory}[2][\embrace{\thenotdefined(\option{/novathesis/coverlang})}]{%
	\optionlistdo{/@nt/langsshort}{\csuse{#2}(##1):={#1}}}

% For PDF bookmakrs
\newdata{coverbkmstring}
\newdata{frontpagebkmstring}
\newdata{copyrightbkmstring}
\newdata{statementbkmstring}
\newdata{dedicatorybkmstring}
\newdata{acknowledgementsbkmstring}
\newdata{quotebkmstring}
\newdata{abstractbkmstring}
\newdata{frontmatterbkmstring}
\newdata{backmatterbkmstring}
\newdata{spinebkmstring}
\newdata{backcoverbkmstring}


\newdata{notdefined}
\newdata{keywordsenvpre}
\newdata{keywordsenvpost}
\newdata{keywordsblockpre}
\newdata{keywordsblockpost}
\newdata{keywordspre}
\newdata{keywordssep}
% \newdata{keywordsboxlen}
\newdata{keywordsstring}
\newdata{keywordsstringprefix}
\newdata{keywordsstringsuffix}
\newdata{keywordsstringfont}
\keywordsblockpre()={\bigskip\noindent}
\keywordsstringsuffix()={:\enspace}
\keywordsstringfont()={\bfseries}
% \keywordssep()={\ \textbf{\Large\textperiodcentered}\ }
\keywordssep()={, }
% \keywordsboxlen()={\textwidth-\widthof{\usebox{\keywordsstringbox}}}

\newdata{specializationstring}
\newdata{departmentofstring}
\newdata{sponsorsstring}
\newdata{andstring}
\newdata{commastring}
\optionlistdo{/@nt/langsshort}{%
	\commastring(#1):={,\ }%
}


\newdata{degreestring}
\newdata{degreestringfont}

\newdata{degreename}
\newdata{degreenamefont}

\newdata{degreenameprefix}
\newdata{degreenameprefixfont}

\newdata{docdegreestring}
\newdata{docdegreestringfont}



\newdata{adviserstring}            % e.g., "Adviser", "Co-adviser"
\newdata{adviserstringfont}
\newdata{adviserstringpre}
\newdata{adviserstringpost}

\newdata{advisernamepre}
\newdata{advisernamepost}
\newdata{advisernamefont}

\newdata{adviserremainderpre}
\newdata{adviserremainderpost}
\newdata{adviserremainderfont}
\adviserremainderfont()={\itshape\scriptsize}

% Committee stuff
\newdata{adviserorder}         %e.g., "{a,c}"
\adviserorder():={a,c}  % By default print advisers and co-advisers
\newdata{committeeorder}         %e.g., "{c,r,a,m,g}"

\newdata{committeetitlestring}      %e.g., "Examinaiton Committee"
\newdata{committeetitlestringpre}
\newdata{committeetitlestringpost}
\newdata{committeetitlestringfont}

\newdata{committeestring}
\newdata{committeestringpre}
\newdata{committeestringpost}
\newdata{committeestringfont}

\newdata{committeenamepre}
\newdata{committeenamepost}
\newdata{committeenamefont}

\newdata{committeeremainderpre}
\newdata{committeeremainderpost}
\newdata{committeeremainderfont}
\committeeremainderfont()={\itshape\scriptsize}

\newdata{personpost}
\newdata{persongrouppost}

\newdata{dissertationstring}
\newdata{dissertationstringfont}

\newdata{copyrighttextstring}
\newdata{acknowledgmentsstring}

\newdata{majorfield}
\newdata{minorfield}
\newdata{specialization}

\newdata{spine}
\newdata{thesiscover}
\newdata{margin}
\newdata{frontpageimage}

% \newcommand*{\@nt@newmemory}[1]{%
%   \newdata{#1}%
%   % \initmemory[\embrace{\MakeUppercase{#1}}]{#1}%
% }
% \forcsvlist{\@nt@newmemory}{university,school,department}
\newdata{university}
\newdata{school}
\newdata{department}

\newdata{doctitle}


% For each main language, list which abstracts shall be printed and in which order
% may have more than two (just be sure you include the languages above as well)
\newdata{abstractorder}
\abstractorder(pt):={pt,en}
\abstractorder(en):={en,pt}
\abstractorder(fr):={fr,en}
\abstractorder(it):={it,en}
\abstractorder(es):={es,en}
\abstractorder(de):={de,en}
\abstractorder(gr):={gr,en}



% --------------------------------------------------------
% PROCESS PACKAGE OPTIONS
\def\@nt@schooloption@i#1/#2\@nil{\gdef\@nt@univ{#1}\gdef\@nt@schl{#2}}

\options{/novathesis/.new family,
	docdegree/.new choice         = {phd, phdprop, phdplan, msc, mscplan, bsc, plain},
	school/.new cmd               = {\@nt@schooloption@i#1\@nil},
	school                        = {nova/fct},
	docstatus/.new choice         = {unset, working, provisional, final}, % in not defined by user, unset will be replaced  “working”
	chapstyle/.new value          = {bar},        % use "bar" chapter style by default
	fontstyle/.new value          = {newpx},      % use “newpx” by default
	langsused/.new list           = {en,pt},
	coverlang/.new choice         = {en, pt, fr, it, de, es, gr},
	copyrightlang/.new choice     = {en, pt, fr, it, de, es, gr},
	lang/.new style               = {/novathesis/mainlang=#1, /novathesis/copyrightlang=#1, /novathesis/coverlang=#1},
	mainlang/.new choice          = {en, pt, fr, it, de, es, gr},
	numberallpages/.new toggle    = false,
	printfrontmatter/.new toggle  = true,
	printadviser/.new toggle      = true,     % fake option - adviser should always be printed
	printcommittee/.new toggle    = false,
	printtimestamp/.new toggle    = true,
	printcopyright/.new toggle    = true,
  printindex/.new toggle         = false,
	webography/.new value         = {},        % empty means do not make a separate webography
	secondcover/.new toggle       = false,
	statement/.new toggle         = false,
	gnumberlist/.new toggle       = true,
	tocintoc/.new toggle          = false,
	urlstyle/.new cmd             = {\AfterPreamble{\urlstyle{#1}}},
	kwncols/.new value            = 2,
	debug/.new list               = {},
	spine/.new choice             = {unset, no, full, trim},
	media/.new choice             = {screen, paper},
	linkscolor/.new cmd           = {\@ifpackageloaded{hyperref}%
			 																							{\hypersetup{allcolors=#1}}%
																										{\PassOptionsToPackage{allcolors=#1}{hyperref}}},
	degreeacr/.new value          = {},
	degreeacr/phd/.new value          = {},
	degreeacr/msc/.new value          = {},
	degreeacr/bsc/.new value          = {},
	degreeacr/plain/.new value          = {},
% nova/itqb
	nova/itqb/covercolor/.new choice      = {gray, green},
% uminho
	uminho/copyrightmodifier/.new choice  = {by-nc-sa, by-sa, by, by-nc, by-nd, by-nc-nd},
	uminho/skipblankcovers/.new toggle    = false,
% ulisboa/fmv
	ulisboa/fmv/examdate/year/.new value      = {year},
	ulisboa/fmv/examdate/month/.new value     = {month},
	ulisboa/fmv/examdate/day/.new value       = {day},
	ulisboa/fmv/scientificarea/.new choice    = {C, MF, PASA, SA},
	ulisboa/fmv/embargo/period/.new choice    = {I, 6, 12},
	ulisboa/fmv/embargo/justification/.new value = {Justification for the temporary embargo.},
	ulisboa/fmv/reproduction/.new choice      = {I, P, N},
}


% --------------------------------------------------------
% PROCESSING CLASS OPTIONS
\options@ProcessOptions{/novathesis}
% --------------------------------------------------------
% NTSETUP2
\def\@ntsetuplevel{}
\newcommand*{\ntsetup}[1]{%
	% \typeout{NTSETUP #1}%
	\ntfor\arg:={#1}\do{%
		\StrCut{\arg}{=}{\@ntopt}{\@ntval}%
		% \typeout{NTSETUP2 [\@ntopt] = [\@ntval]}%
		\ifoptiondefined{/novathesis/\@ntopt}%
										{\options{/novathesis/#1}}{%
		\ifoptiondefined{/novathesis/\@ntsetuplevel\@ntopt}%
	 									{\options{/novathesis/\@ntsetuplevel#1}}{%
	  \ClassError{Invalid class option: \@ntopt}{}{}}}}}

\newcommand*{\ntbibsetup}[1]{%
	\@ifpackageloaded{biblatex}{\bibsetup{#1}}{\PassOptionsToPackage{#1}{biblatex}}%
	% {\options{/@nt/biblatex/.push={#1}}}%
}

\newcommand*{\NTAddToHook}[2]{\options{/@nt/hook/#1/.cpush={#2}}}

\newcommand*{\NTRunHook}[1]{\optionlistdo{/@nt/hook/#1}{##1}}

% \newcommand*{\NTIfHook}[1]{%
%   \ifoptiondefined{/@nt/hook/#1}%
% }


% --------------------------------------------------------
% Pass the remaining options to memoir
% \letoptionlist{/options/remaining}\nt@remaining
% \PassOptionsToClass{\nt@remaining}{memoir}





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% LOADING CUSTOMIZATION STUFF - part 1
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% --------------------------------------------------------
% Define DEFAULT VALUES for COVER and COPYRIGHT languages
%     and HYPERLINK color
\options{/novathesis/.cd,
	coverlang = \option{/novathesis/mainlang},
	copyrightlang = \option{/novathesis/mainlang},
	linkscolor = DarkBlue,
}

% \NTRunHook{memoir}

%============================================================
%  TEMPLATE CUSTOMIZATION / OPTIONS
%      Please open and edit the appropriate
%       configuration file “Config/1_novathesis.tex”
%============================================================
\input{Config/1_novathesis}
\options{/@nt/document/docclass=\option{/novathesis/docdegree}}
% \NTRunHook{novathesis}

%============================================================
% BIBLATEX CUSTOMIZATION
%      Please open and edit the appropriate
%       configuration file “Config/2_biblatex.tex”
%============================================================
\input{Config/2_biblatex}
% \NTRunHook{biblatex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Include strings for all the languages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\optionlistdo{/novathesis/langsused}{%
		\InputIfFileExists{NOVAthesisFiles/Strings/strings-#1.ldf}%
											{}%
											{\ClassError{novathesis}{File not found: “NOVAthesisFiles/Strings/strings-#1.ldf” file!}%
																							{Add a file with the translations for this language.}}%
}

% --------------------------------------------------------
% BABEL STUFF
\options{/@nt/langshorttolong=\option{/novathesis/mainlang}}%
\PassOptionsToPackage{main=\option{/@nt/langshorttolong}}{babel}
% \typeout{MAIN: [\option{/novathesis/mainlang} \option{/@nt/langshorttolong}]}\aaa
\optionlistdo{/novathesis/langsused}{%
	\options{/@nt/langshorttolong=#1}%
  \PassOptionsToPackage{\option{/@nt/langshorttolong}}{babel}%
  % \typeout{USED: [#1] [\option{/@nt/langshorttolong}] [\option{/@nt/fontenc}]}\bbb
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DEFINITIONS FOR THE REMINDER OF CUSTOMIZATION STUFF
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% --------------------------------------------------------
% Department
\def\ntdepartment{\@ifstar{\@ntdepartmentifundef}{\@ntdepartment}}
\def\@ntdepartmentifundef(#1)#2{\ifdatadefined{department}(#1){}{\@ntdepartment(#1){#2}}}
\def\@ntdepartment(#1)#2{\department(#1):={#2}}

% --------------------------------------------------------
% Degree
\def\ntmajorfield{\@ifstar{\@ntmajorfieldifundef}{\@ntmajorfield}}
\def\@ntmajorfieldifundef(#1)#2{\ifdatadefined{majorfield}(#1){}{\@ntmajorfield(#1){#2}}}
\def\@ntmajorfield(#1)#2{\majorfield(#1):={#2}}

\def\ntdegreename{\@ifstar{\@ntdegreenameifundef}{\@ntdegreename}}
\def\@ntdegreenameifundef(#1)#2{\ifdatadefined{degreename}(#1){}{\@ntdegreename(#1){#2}}}
\def\@ntdegreename(#1)#2{%
	% #1 = ignored
	% #1 = lang
	% #2 = value
	\datamatch{\match}{degreenameprefix}(%
						{\option{/novathesis/docdegree},%
						 \option{/novathesis/degreeacr/\option{/@nt/document/docclass}},%
						 \option{/novathesis/coverlang}},%
						{\option{/@nt/document/docclass},%
						 \option{/novathesis/degreeacr/\option{/@nt/document/docclass}},%
						 \option{/novathesis/coverlang}},%
						{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},%
						 \option{/novathesis/coverlang}},%
						{\option{/novathesis/docdegree},\option{/novathesis/coverlang}},%
						{\option{/@nt/document/docclass},\option{/novathesis/coverlang}},%
						{\option{/novathesis/coverlang}}%
	)%
	\ifblank{\match}{\degreename(#1):={#2}}{\degreename(#1):={\match\ #2}}%
	\majorfield(#1):={#2}%
}
% --------------------------------------------------------
% Specialization
\def\ntminorfield{\@ifstar{\@ntminorfieldifundef}{\@ntminorfield}}
\def\@ntminorfieldifundef(#1)#2{\ifdatadefined{minorfield}(#1){}{\@ntminorfield(#1){#2}}}
\def\@ntminorfield(#1)#2{\minorfield(#1):={#2}}

\def\ntspecialization{\@ifstar{\@ntspecializationifundef}{\@ntspecialization}}
\def\@ntspecializationifundef(#1)#2{\ifdatadefined{specialization}(#1){}{\@ntspecialization(#1){#2}}}
\def\@ntspecialization(#1)#2{%
	\datamatch{\match}{specializationstring}(%
						{\option{/novathesis/docdegree},%
						 \option{/novathesis/degreeacr/\option{/@nt/document/docclass}},%
						 \option{/novathesis/coverlang}},%
						{\option{/@nt/document/docclass},%
						 \option{/novathesis/degreeacr/\option{/@nt/document/docclass}},%
						 \option{/novathesis/coverlang}}%
						{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},%
						 \option{/novathesis/coverlang}},%
						{\option{/novathesis/docdegree},\option{/novathesis/coverlang}},%
						{\option{/@nt/document/docclass},\option{/novathesis/coverlang}},%
						{\option{/novathesis/coverlang}}%
	)%
	\ifblank{\match}{\specialization(#1):={#2}}{\specialization(#1):={\match\ #2}}%
	\minorfield*(#1):={#2}%
}

% --------------------------------------------------------
% Sponsors
\def\ntsponsors(#1)#2{\sponsorsstring(#1):={#2}}

% --------------------------------------------------------
% Title
\def\nttitle(#1,#2)#3{%
	% #1 = type (main, sub, spine) title
	% #2 = lang
	% #3 = value
	% \typeout{NT TITLE [#1] [#2] [#3]}%
  \StrSubstitute{#3}{\\}{ }[\@nt@cleantitle]
  % \typeout{XXXX [\@nt@cleantitle]}\aaa
	\doctitle(#2,#1):={\@nt@cleantitle}%
	\doctitle(#2,#1,cover):={#3}%
	\IfStrEq{#1}{main}{\doctitle(#2,spine):={\@nt@cleantitle}}{}%
  % \doctitle(#2,#1):={\ntnolinebreak{#3}}%
  % \doctitle(#2,#1,cover):={#3}%
  % \IfStrEq{#1}{main}{\doctitle(#2,spine):={\ntnolinebreak{#3}}}{}%
}

% \newcommand{\ntnolinebreak}[1]{{\def\\{\ }#1}}
% --------------------------------------------------------



%============================================================
% Date and month
\newdata{ntdocdate}
\ntdocdate(year):={Year}
\ntdocdate(month):={month}

\def\ntdate#1{\@ntdate@i(#1,)}
\def\@ntdate@i(#1,#2){%
	\StrGobbleRight{#2}{1}[\@ntmonth]%
	\ntdocdate(year):={#1}%
	\ntdocdate(month):={\@ntmonth}%
}



%============================================================
% Author identification
\newdata{docauthor}
\docauthor(name):={Author Name}
\docauthor(name,short):={Author Short Name}
\docauthor(gender):={Author Gender}
\docauthor(degree,\option{/novathesis/coverlang}):={Author Previous Degree}

\def\ntauthorname(#1)#2#3{% [m|f]{Long name}{Short name}
	\docauthor(gender):={#1}%
	\docauthor(name):={#2}%
	\docauthor(name,short):={#3}}

\def\ntauthordegree(#1)#2{\docauthor(degree,#1):={#2}}

%============================================================
% Adding list_of
\newcommand*{\ntaddlistof}[2][]{%
	\IfStrEqCase{#2}{%
		{tableofcontents}{\options{/@nt/list/listof/.cpush={%
						\iftoggle{/novathesis/tocintoc}{\tableofcontents}%
									{\pdfbookmark{\contentsname}{toctarget}%
									\hypertarget{toctarget}{\tableofcontents*}}}}}%
		{listoffigures*}{\options{/@nt/list/listof/.cpush={%
						\pdfbookmark{\listfigurename}{loftarget}%
						\hypertarget{loftarget}{\listoffigures*}}}}%
		{listoftables*}{\options{/@nt/list/listof/.cpush={%
						\pdfbookmark{\listtablename}{lottarget}%
						\hypertarget{lottarget}{\listoftables*}}}}%
		{listoflistings}{\options{/@nt/list/listof/.cpush={%
						\pdfbookmark{\listoflistingscaption}{loltarget}%
						\hypertarget{loltarget}{\listoflistings}}}}%
		{listofalgorithms}{\options{/@nt/list/listof/.cpush = {%
						\listofalgorithms
						\ifdefined\listalgorithmname%
							\addcontentsline{toc}{chapter}{\listalgorithmname}%
						\else\ifdefined\listalgorithmcfname%
							\addcontentsline{toc}{chapter}{\listalgorithmcfname}%
						\else
							\ClassError{novathesis}{Can't make list of algorithms. Please report this problem in the “novathesis” github. Thanks!}{}%
						\fi\fi}}}%
		{listsofglossaries}{\options{/@nt/list/listof/.cpush={%
						\glstoctrue
						\iffileadded[glossary]{glossaries}{\patchcmd{\@glo@types}{,main}{}{}{}}{}}}}%
		{listsofglossaries*}{\options{/@nt/list/listof/.cpush={%
						\glstocfalse
		\iffileadded[glossary]{glossaries}{\patchcmd{\@glo@types}{,main}{}{}{}}{}}}}%
	}[%
            \if\relax\detokenize{#1}\relax
              \options{/@nt/list/listof/.cpush={\ifdefmacro{#2}{#2}{\csuse{#2}}}}%
            \else
              \options{/@nt/list/listof/.cpush={\ifdefmacro{#2}{#2[#1]}{\csuse{#2}[#1]}}}%
            \fi
   ]%
}

%============================================================
% Print document “parts/sections/regions”
\newcommand*{\ntprint}[1]{%
	\IfStrEqCase{#1}{%
		{frontmatter}{%
					\iftoggle{/novathesis/secondcover}{}{\setcounter{page}{1}}%
					\iftoggle{/novathesis/printfrontmatter}{\ntprintlist{/@nt/print/#1}}{}}%
		{mainmatter}{%
						\ntprintlist{/@nt/print/#1}}%
	}[\ifdefmacro{#1}{#1}{\csuse{ntprint#1}\clearforchapter}]%
	\ignorespaces%
}

\newcommand*{\ntprintlist}[1]{%
	\optionlistdo{#1}{%
		\ifdefmacro{##1}{##1}{%
			\ifcsmacro{ntprint##1}%
						{\NTRunHook{ntprint##1/pre}\csuse{ntprint##1}\NTRunHook{ntprint##1/post}}%
						{\ifcsmacro{##1}{\NTRunHook{##1/pre}\csuse{##1}\NTRunHook{##1/post}}
													  {\ClassError{novathesis}{Invalid contents for frontmatter or mainmatter: [##1]}{}}}}
		\clearforchapter}%
}

\newcommand*{\ntsetprintorder}[2]{%
  % #1 = frontmatter, mainmatter
  % #2 = list
  % \typeout{[#1] [#2]}
  \option@setlist[;]{/@nt/print/#1}{#2}%
}

\newcommand*{\ntaddtoprintorder}[2]{%
  % #1 = frontmatter, mainmatter
  % #2 = list
  % \typeout{[#1] [#2]}
  \options{/@nt/print/#1/.push=#2}%
}

% \newcommand*{\ntremovefromprintorder}[2]{%
% % #1 = frontmatter, mainmatter
% % #2 =single item to remove
%   \@for\@nt@item:=#2\do{\options{/@nt/print/#1/.remove = {\@nt@item}}}}

% --------------------------------------------------------
% DEFAULT VALUES FOR frontmatter AND mainmatter
\newdata{printorder}

\printorder(frontmatter,final):={%
	statement;       % The statement page
	copyright;       % (*) The copyright page
	dedicatory;      % (*) Print the dedicatory
	acknowledgements;% (*) Print the acknowledgments
	quote;           % (*) Print the quote
	abstracts;       % Print abstracts in multiple languages.
	alllistof;       % Print all the listof defined in “6_list_of.tex”
	printglossaries; % Print the Glossary, Acronyms, Symbols, etc…
}

\printorder(frontmatter,provisional):={%
	statement;       % The statement page
	copyright;       % (*) The copyright page
	dedicatory;      % (*) Print the dedicatory
	acknowledgements;% (*) Print the acknowledgments
	quote;           % (*) Print the quote
	abstracts;       % Print abstracts in multiple languages.
	alllistof;       % Print all the listof defined in “6_list_of.tex”
	printglossaries; % Print the Glossary, Acronyms, Symbols, etc…
}

\printorder(frontmatter,working):={%
	abstracts;       % Print abstracts in multiple languages.
	alllistof;       % Print all the listof defined in “6_list_of.tex”
	printglossaries; % Print the Glossary, Acronyms, Symbols, etc…
}

\ifoptionequal{/novathesis/webography}{}{%
	\ntsetprintorder{mainmatter}{
		chapters;        % Print document chapters
		bib;             % Print the bibliography.  Change to
		 %    “bib[title=⟨title⟩]” to redefine the title!
		appendices;      % Print appendices; if any!
		annexes;         % Print annexes; if any!
	}%
}{%
	\ntsetprintorder{mainmatter}{
		chapters; % Print document chapters
		\printbibliography[nottype=online]; % Print the bibliography.
		\printbibliography[title=\option{/novathesis/webography},type=online]; % Print the bibliography.
		appendices; % Print appendices, if any!
		annexes; % Print annexes, if any!
	}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% COVER DEFINITION MACROS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\ntaddtocover}[3][]{%
	% #1 = cover atrtibutes
	% #2 = list of covers where the code block should be applied
	% #3 = the block code
	% \typeout{NT ntaddtocover [/@nt/cover/\@nt@univ/\@nt@schl/element=#1]}%
  % \forcsvlist{\@ntaddtocover@iii{#1}{#3}}{#2}%
  \ntfor\arg:={#2}\do{\@ntaddtocover@iii{#1}{#3}{\arg}}%
}

\newcommand*{\@ntaddtocover@iii}[3]{%
	% \typeout{NT ntaddtocover #3}%
	% #1 = cover atrtibutes
	% #2 = the block code
	% #3 = covers where the code block should be applied
	\ntfor\arg:={#3}\do{\options{/@nt/cover/\@nt@univ/\@nt@schl/\arg/.cpush={{#1}=*={#2}}}}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% LOADING SCHOOLS's “defaults.ldf”
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ntfor\match:={\@nt@univ,\@nt@univ/\@nt@schl}\do{%
		\IfFileExists{NOVAthesisFiles/Schools/\match/Images/DO_NOT_REMOVE_THIS_FILE.txt}{%
						\prependtographicspath{{NOVAthesisFiles/Schools/\match/Images/}}}{}}


%============================================================
%  UNIVERSITY/SCHOOL SPECIFIC MATERIALS
%  configuration file “Config/9_<university>_<school>.tex”
%============================================================
\IfFileExists{Config/9_\@nt@univ_\@nt@schl.tex}
		 {\def\@ntsetuplevel{\@nt@univ/\@nt@schl/}\input{Config/9_\@nt@univ_\@nt@schl.tex}}
		 {\def\@ntsetuplevel{\@nt@univ/}\InputIfFileExists{Config/9_\@nt@univ.tex}{}{}}
\def\@ntsetuplevel{}

\InputIfFileExists{NOVAthesisFiles/Schools/\@nt@univ/\@nt@univ-defaults.ldf}{}
		{\PackageError{novathesis}{Missing file “/\@nt@univ/\@nt@univ-defaults.ldf”}{}}

\ntfor\match:={%
      \@nt@univ-\@nt@schl-\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},%
      \@nt@univ-\@nt@schl%
  }\do{%
      \IfFileExists{NOVAthesisFiles/Schools/\@nt@univ/\@nt@schl/\match-defaults.ldf}
              {\input{NOVAthesisFiles/Schools/\@nt@univ/\@nt@schl/\match-defaults.ldf}\ntforbreak}{}%
  }
[\PackageError{novathesis}{Missing file “NOVAthesisFiles/Schools/\@nt@univ/\@nt@schl-defaults.ldf”}{}]



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifxetexorluatex  % xelatex or lualatex
	\RequirePackage{fontspec}%
	\defaultfontfeatures{Ligatures=TeX}
\else% pdflatex
  % \RequirePackage[T1]{fontenc}    % Use new T1 fonts
  % \RequirePackage[utf8]{inputenc}    % Format for the input file(s), see the "enc" option
\fi


% --------------------------------------------------------
% Customize the pagestyle
\makepagestyle{novathesis@mainmatter} 
\makeoddfoot{novathesis@mainmatter}{}{\thepage}{} 
\makeevenfoot{novathesis@mainmatter}{}{\thepage}{} 
\makeheadrule{novathesis@mainmatter}{\textwidth}{\normalrulethickness} 
\makeevenhead{novathesis@mainmatter}{\small\textsc{\leftmark}}{}{} 
\makeoddhead{novathesis@mainmatter}{}{}{\small\textsc{\rightmark}}

\makepagestyle{novathesis@frontmatter} 
\makeoddfoot{novathesis@frontmatter}{}{\thepage}{} 
\makeevenfoot{novathesis@frontmatter}{}{\thepage}{} 

\ifoptionequal{/novathesis/media}{paper}{\ntsetup{linkscolor=Black}}{}


% --------------------------------------------------------
% If option “debug={index}” option is active,
%     highlight index keywords in the main text
\providecommand*{\debugindexcolor}{red!50}
\ifoptioncontains{/novathesis/debug}{index}{%
  % \PassOptionsToPackage{inline}{showlabels}%
  \AtEndPreamble{\RequirePackage{showlabels}%
  \showlabels[\color{\debugindexcolor}]{index}}%
}{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% LOADING CUSTOMIZATION STUFF - part 2
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%============================================================
%  THESIS/DISSERTATION COVER DATA (title, author, etc)
%   Please open and edit the appropriate
%       configuration file “Config/3_cover.tex”
%============================================================
\input{Config/3_cover}
% \NTRunHook{cover}

%============================================================
%  THESIS/DISSERTATION FILES
%   Please open and edit the appropriate
%       configuration file “Config/4_files.tex”
%============================================================
\input{Config/4_files}
% \NTRunHook{files}

%============================================================
% ADDITIONAL PACKAGES and MACROS
%      Please open and edit the appropriate
%       configuration file “Config/8_packages.tex”
%============================================================
% \newcommand{\BeforeHyperref}[1]{\NTAddToHook{packages/pre}{#1}}
% \newcommand{\AfterHyperref}[1]{\NTAddToHook{packages/post}{#1}}
% \NTRunHook{packages/pre}
\AtEndPreamble{\input{Config/5_packages}}
% \NTRunHook{packages/post}

%============================================================
%  WHICH LIST_OF TO PRINT
%   Please open and edit the appropriate
%       configuration file “Config/6_list_of.tex”
%============================================================
\AtEndPreamble{\makeatletter\NTRunHook{list_of/pre}\input{Config/6_list_of}\NTRunHook{list_of/post}}

\ifdocunset{\ntsetup{docstatus=working}}{}

% \typeout{\theprintorder(frontmatter,\option{/novathesis/docstatus})}
\ntsetprintorder{frontmatter}{\expanded{\theprintorder(frontmatter,\option{/novathesis/docstatus})}}%

\ifoptionequal{/novathesis/spine}{unset}
		{\ifdocworking{\ntsetup{spine=no}}{\ifmaindoc{\ntsetup{spine=trim}}{\ntsetup{spine=no}}}}{}
\ifdocfinal{\ntsetup{printcommittee=true}}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\@nt@loadallfiles}[3][]{\optionlistdo{/@nt/file/#3/#2}{\@ntloadfile@i{##1}#1}}

\newcommand{\@ntloadfile@i}[2][]{\IfFileExists{#2}{\input{#2}}{#1}}

\newcommand{\@ntloadfiles@ii}[2][VAL]{%
	% #1=KEY
	% #2=file class
  \iffileadded[#1]{#2}{\@nt@loadallfiles[\clearforchapter]{#1}{#2}}{}%
}

\newcommand{\iffileadded}[2][VAL]{\ifoptiondefined{/@nt/file/#2/#1}}

% --------------------------------------------------------
% LOAD ADDITIONAL PACKAGES
\input{NOVAthesisFiles/packages.tex}
\NTRunHook{NOVAthesisFiles/packages}

% Patch month from number to string in the proper language
\IfInteger{\thentdocdate(month)}{%
	\RequirePackage{datetime}%
	\edef\@nt@datemonth{\thentdocdate(month)}%
	\ntdocdate(month)={\bgroup\ntselectlang{\option{/novathesis/coverlang}}\monthname[\@nt@datemonth]\egroup}}%
{}


% --------------------------------------------------------
% FIX BABEL TRANSLATION
\input{NOVAthesisFiles/fix-babel.tex}

% --------------------------------------------------------
% LOAD A DEFAULT COPYRIGHT PAGE DEFINITION
\newcommand{\@nt@AddFileIfExists}[1]{%
% #1 = class
% #2 = sub class [OPTIONAL]
% #3 = file name
% #4 = dir list
% #5 = action if not found [OPTIONAL]
  \@ifnextchar[{\@nt@AddFileIfExists@i{#1}}{\@nt@AddFileIfExists@i{#1}[VAL]}%
}

\def\@nt@AddFileIfExists@i#1[#2]#3#4{%
  \@ifnextchar[{\@nt@AddFileIfExists@ii{#1}[#2]{#3}#4}{\@nt@AddFileIfExists@ii{#1}[#2]{#3}#4[]}%
}

\long\def\@nt@AddFileIfExists@ii#1[#2]#3#4[#5]{%
  \ntfor\arg:=#4\do{\IfFileExists{\arg#3}{\ntaddfile{#1}[#2]{\arg#3}\ntforbreak}{}}[#5]%
}


% \newcommand{\@nt@AddFileIfExists}[4][]{%
% % #1 = OPTIONAL action if not found
% % #2 = class
% % #3 = file name
% % #4 = dir list
%   \ntfor\arg:=#4\do{\@nt@AddFileIfExists@i{#2}{#3}{\arg}}[#1]%
% }
%
% \newcommand{\@nt@AddFileIfExists@i}[3]{%
% % #1 = class
% % #2 = file name
% % #3 = dir list
%   \IfFileExists{#3#2}{\ntaddfile{#1}{#3#2}\ntforbreak}{}%
% }

\ifmaindoc{% only print if a main document
	\iftoggle{/novathesis/printcopyright}{% if copuyright toggle is on
		\@nt@AddFileIfExists{copyright}{copyright.ldf}{%
					 {NOVAthesisFiles/Schools/\@nt@univ/\@nt@schl/}%
					,{NOVAthesisFiles/Schools/\@nt@univ/}%
					,{NOVAthesisFiles/}%
		}%
		\@ntloadfiles@ii{copyright}%
	}{}%
}{}

\ifoptionequal{/novathesis/spine}{no}{}{%
	\@nt@InputIfFileExists{spine.tex}{%
					 {NOVAthesisFiles/Schools/\@nt@univ/\@nt@schl/}%
					,{NOVAthesisFiles/Schools/\@nt@univ/}%
					,{NOVAthesisFiles/}%
	}[][\ClassError{novathesis}{No “spine” file found.}{}]%
	\AtEndDocument{\csuse{ntprintspine}}%
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DEBUG - print grid over covers and spine
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\debuggrid}[1][orange]{%
	\begin{tikzpicture}[remember picture, semitransparent, overlay, shift=(current page.north west)]%
		\draw[step=1mm, line width=0.1mm, #1!30!white, yscale=-1] (\@nt@margin@left, \@nt@margin@top)
							grid (\paperwidth-\@nt@margin@right, \paperheight-\@nt@margin@bottom);
		\draw[step=5mm, line width=0.2mm, #1!40!white] (current page.north west)
							grid (current page.south east);
		\draw[step=1cm, line width=0.3mm, #1!90!white] (current page.north west)
							grid (current page.south east);
		\draw[step=5cm, line width=0.5mm, #1!50!white] (current page.north west)
							grid (current page.south east);
		\end{tikzpicture}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% PRINT DOCUMENT PARTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\ifcoverdefined}[3][1-1]{%
	% #1 = cover number
	% #2 = true branch
	% #3 = false branch
	% \edef\asd{/@nt/cover/\@nt@univ/\@nt@schl/#1}
	% \show\asd
	\ifoptiondefined{/@nt/cover/\@nt@univ/\@nt@schl/#1}{#2}{%
		\datamatchtf{\match}{thesiscover}(%
			 {\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bgcolor}%
			,{\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bgcolor}%
			,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bgcolor}%
			,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},bgcolor}%
			,{\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,image}%
			,{\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,image}%
			,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,image}%
			,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},image}%
			,{\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bgcolor}%
			,{\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bgcolor}%
			,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bgcolor}%
			,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},bgcolor}%
			,{\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,image}%
			,{\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,image}%
			,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,image}%
			,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},image}%
			,{\option{/novathesis/docdegree},#1,bgcolor}%
			,{\option{/@nt/document/docclass},#1,bgcolor}%
			,{#1,bgcolor}%
			,{bgcolor}%
			,{\option{/novathesis/docdegree},#1,image}%
			,{\option{/@nt/document/docclass},#1,image}%
			,{#1,image}%
			,{image}%
			,{\option{/novathesis/docdegree},#1,bgcolor}%
			,{\option{/@nt/document/docclass},#1,bgcolor}%
			,{#1,bgcolor}%
			,{bgcolor}%
			,{\option{/novathesis/docdegree},#1,image}%
			,{\option{/@nt/document/docclass},#1,image}%
			,{#1,image}%
			,{image}%
		){#2}{#3}%
	}%
}

\newcommand{\ntprintbackcover}{%
	\ifcoverdefined[N-1]{\pdfbookmark[-1]{\thebackmatterbkmstring(\option{/novathesis/coverlang})}{bmbackmatter}}{%
	\ifcoverdefined[N-2]{\pdfbookmark[-1]{\thebackmatterbkmstring(\option{/novathesis/coverlang})}{bmbackmatter}}{}}%
	\ntprintcoverpair{N}%
}

\newcommand{\ntprintcovers}[1][1,2]{%
	\pdfbookmark[-1]{\thefrontmatterbkmstring(\option{/novathesis/coverlang})}{bmfrontmatter}%
	\NTAddToHook{mainmatter/pre}{\bookmarksetup{startatroot}}%
  % \forcsvlist{\ntprintcoverpair}{#1}%
  \ntfor\arg:={#1}\do{\ntprintcoverpair{\arg}}%
}

\newcommand{\ntprintcoverpair}[1]{%
  % #1 = major cover ID
  \iffileadded[1]{cover}{%
    \iffileadded[#1]{cover}{%
      \optionlistdo{/@nt/file/cover/#1}{\bgroup\thispagestyle{empty}\@ntloadfile@i[\ClassError{novathesis}{Invalid cover file: “##1”}{}]{##1}\egroup\clearforchapter}%
      \ntprintcoversingle{2}{1}%
    }{}%
  }{%
    \IfStrEqCase{#1}{%
      {1}{\ntprintcoversingle{#1}{1}\ntprintcoversingle{#1}{2}\clearforchapter}%
      {2}{\iftoggle{/novathesis/secondcover}
                   {\ntprintcoversingle{#1}{1}\ntprintcoversingle{#1}{2}\clearforchapter}{}}%
      {N}{\ntprintcoversingle{#1}{1}\ntprintcoversingle{#1}{2}}%
    }[\ClassWarning{Invalid cover number: #1}{}]%
  }
}

\newcommand{\ntprintcoversingle}[2]{%
  % #1 = major cover ID
  % #2 = minor cover ID
  \def\@nt@newpage{}%
  \gdef\@covernumber{#1-#2}%
  \IfStrEq{#2}{2}{%
    \ifbool{@openright}{\def\@nt@newpage{\thispagestyle{cleared}\cleartoevenpage}}{\clearpage}%
  }{}%
  \IfStrEq{#1-#2}{2-1}{\setcounter{page}{1}}{}%
  \edef\@cvn{#1-#2}
  \edef\@cvnonetwo{1-2}
  \edef\@cvnNone{N-1}
  \ifx\@cvn\@cvnonetwo\relax
    \iftoggle{/novathesis/uminho/skipblankcovers}{}
                       {\ifcoverdefined[#1-#2]{\@nt@newpage\@ntprintcover@i{#1-#2}}{}}%
  \else\ifx\@cvn\@cvnNone\relax
    \iftoggle{/novathesis/uminho/skipblankcovers}{}
                       {\ifcoverdefined[#1-#2]{\@nt@newpage\@ntprintcover@i{#1-#2}}{}}%
  \else
    \ifcoverdefined[#1-#2]{\@nt@newpage\@ntprintcover@i{#1-#2}}{}%a
  \fi\fi
}

\newcommand{\@ntprintcover@i}[1]{%
  % #1 = cover ID (major-minor)
  \begingroup%
    \NTRunHook{cover/#1/pre}%
    \datamatchtf{\match}{thesiscover}(%
                {\option{/novathesis/docdegree},\option{/novathesis/degreeacr},#1,textcolor}%
               ,{\option{/@nt/document/docclass},\option{/novathesis/degreeacr},#1,textcolor}%
               ,{\option{/novathesis/degreeacr},#1,textcolor}%
               ,{\option{/novathesis/degreeacr},textcolor}%
               ,{\option{/novathesis/docdegree},#1,textcolor}%
               ,{\option{/@nt/document/docclass},#1,textcolor}%
               ,{#1,textcolor}%
               ,{textcolor}%
    ){\color{\match}}{}%
    \ntselectlang{\option{/novathesis/coverlang}}%
    \options{/@ntcoveropts/bookmark=#1}%
    \ifoptionequal{/@ntcoveropts/bookmark}{}{}{%
      \pdfbookmark[1]{\option{/@ntcoveropts/bookmark}}{\option{/@ntcoveropts/bookmark}}%
    }%
    \@ntmakeboxwithcover{#1}{\@fullcover@box}%
    \NTRunHook{cover/#1/post}%
  \endgroup%
}

\newcommand{\@ntmakeboxwithcover}[2]{%
		% #1 = cover ID (major-minor)
		% #2 = box name
		\datamatch{\@nt@margin@top}{margin}(%
		{cover,\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,top}%
		 ,{cover,\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,top}%
		 ,{cover,\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,top}%
		 ,{cover,\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},top}%
		 ,{cover,\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},top}%
		 ,{cover,\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},top}%
		 ,{cover,\option{/novathesis/docdegree},#1,top}%
		 ,{cover,\option{/@nt/document/docclass},#1,top}%
		 ,{cover,#1,top}%
		 ,{cover,\option{/novathesis/docdegree},top}%
		 ,{cover,\option{/@nt/document/docclass},top}%
		 ,{cover,top})%
		\datamatch{\@nt@margin@bottom}{margin}(%
		{cover,\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bottom}%
		 ,{cover,\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bottom}%
		 ,{cover,\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bottom}%
		 ,{cover,\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},bottom}%
		 ,{cover,\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},bottom}%
		 ,{cover,\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},bottom}%
		 ,{cover,\option{/novathesis/docdegree},#1,bottom}%
		 ,{cover,\option{/@nt/document/docclass},#1,bottom}%
		 ,{cover,#1,bottom}%
		 ,{cover,\option{/novathesis/docdegree},bottom}%
		 ,{cover,\option{/@nt/document/docclass},bottom}%
		 ,{cover,bottom})%
		\datamatch{\@nt@margin@left}{margin}(%
		{cover,\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,left}%
		 ,{cover,\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,left}%
		 ,{cover,\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,left}%
		 ,{cover,\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},left}%
		 ,{cover,\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},left}%
		 ,{cover,\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},left}%
		 ,{cover,\option{/novathesis/docdegree},#1,left}%
		 ,{cover,\option{/@nt/document/docclass},#1,left}%
		 ,{cover,#1,left}%
		 ,{cover,\option{/novathesis/docdegree},left}%
		 ,{cover,\option{/@nt/document/docclass},left}%
		 ,{cover,left})%
		\datamatch{\@nt@margin@right}{margin}(%
		{cover,\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,right}%
		 ,{cover,\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,right}%
		 ,{cover,\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,right}%
		 ,{cover,\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},right}%
		 ,{cover,\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},right}%
		 ,{cover,\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},right}%
		 ,{cover,\option{/novathesis/docdegree},#1,right}%
		 ,{cover,\option{/@nt/document/docclass},#1,right}%
		 ,{cover,#1,right}%
		 ,{cover,\option{/novathesis/docdegree},right}%
		 ,{cover,\option{/@nt/document/docclass},right}%
		 ,{cover,right})%
		% \defifundef{#2}{\newsavebox}%
		\@ntmakecoverbgcolor{#1}{\@cover@bgcolor@box}%
		\@ntmakecoverimage{#1}{\@cover@image@box}%
		\@ntmakecovertext{#1}{\@cover@text@box}%
		\thispagestyle{empty}%
		\begin{tikzpicture}[remember picture, overlay]
		\node[inner sep=0, anchor=north]  at (current page.north)
		{\usebox{\@cover@bgcolor@box}};
		\node[inner sep=0, anchor=north]  at (current page.north)
		{\usebox{\@cover@image@box}};
		\node[inner sep=0
		, anchor=north west
		, xshift=\@nt@margin@left
		, yshift=-\@nt@margin@top] at (current page.north west)
		{\usebox{\@cover@text@box}};
		\end{tikzpicture}%
		\ifoptioncontains{/novathesis/debug}{cover}{%
		\NTRunHook{cover/#1/grid/pre}%
		\debuggrid%
		\NTRunHook{cover/#1/grid/post}%
		}{}%
}

\newcommand*{\@ntmakecoverbgcolor}[2]{%
		% #1 = cover ID (major-minor)
		% #2 = box name
		\defifundef{#2}{\newsavebox}%
		\datamatchtf{\match}{thesiscover}(%
		{\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bgcolor}%
		 ,{\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bgcolor}%
		 ,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,bgcolor}%
		 ,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},bgcolor}%
		 ,{\option{/novathesis/docdegree},#1,bgcolor}%
		 ,{\option{/@nt/document/docclass},#1,bgcolor}%
		 ,{#1,bgcolor}%
		 ,{bgcolor}%
		){\savebox{#2}{\@ntcoverbgcolor{#1}{\match}}}{}%
}

\newcommand*{\@ntcoverbgcolor}[2]{%
		% #1 = cover ID (major-minor)
		% #2 = color
		\begingroup%
		\color{#2}%
		\NTRunHook{cover/#1/bgcolor/pre}%
		\rule{\paperwidth}{\paperheight}%
		\NTRunHook{cover/#1/gcolor/post}%
		\endgroup%
}

\newcommand*{\@ntmakecoverimage}[2]{%
		% #1 = cover ID (major-minor)
		% #2 = box name
		\NTRunHook{cover/#1/image/pre}%
		\defifundef{#2}{\newsavebox}%
		\datamatchtf{\match}{thesiscover}(%
		{\option{/novathesis/docdegree},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,image}%
		 ,{\option{/@nt/document/docclass},\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,image}%
		 ,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},#1,image}%
		 ,{\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},image}%
		 ,{\option{/novathesis/docdegree},#1,image}%
		 ,{\option{/@nt/document/docclass},#1,image}%
		 ,{#1,image}%
		 ,{image}%
		){\savebox{#2}{\includegraphics[width=\paperwidth,height=\paperheight]{\match}}}{}%
		\ifdatadefined{thesiscover}(phd,1-1,bgcolor){}{}%
		\NTRunHook{cover/#1/image/post}%
}

\newcommand{\@ntmakecovertext}[2]{%
		% #1 = cover ID (major-minor)
		% #2 = box name
		\defifundef{#2}{\newsavebox}%
		\ifoptiondefined{/@nt/cover/\@nt@univ/\@nt@schl/#1}{%
		\begin{lrbox}{#2}%
		\begin{minipage}[l]%
		[\dimexpr\paperheight-\@nt@margin@top-\@nt@margin@bottom]%
		{\dimexpr\paperwidth-\@nt@margin@left-\@nt@margin@right}%
		\@ntcovertext{#1}%
		\end{minipage}%
		\end{lrbox}%
		}{}%
}

\newcommand{\@ntcovertext}[1]{%
		% #1 = cover ID (major-minor)
		\NTRunHook{cover/#1/text/pre}%
		\optionlistdo{/@nt/cover/\@nt@univ/\@nt@schl/#1}{\@ntcoverelement@iii{#1}##1}%
		\NTRunHook{cover/#1/text/post}%
}

\def\instring#1#2{TT\fi\begingroup
  \edef\x{\endgroup\noexpand\in@{#1}{#2}}\x\ifin@}

\def\@ntcoverelement@iii#1#2=*=#3{%
  % #1 = cover ID (major-minor)
  % #2 = cover element options
  % #3 = cover element code
  % \typeout{[#1] [#2]}\xxxx
  \ifblank{#3}{}{%
    \options{/@ntcoveropts,defaults}%.
    \options{/@ntcoveropts,#2}%
    \options{/@ntcoveropts,alignmap=\option{/@ntcoveropts/halign}}%
    % \StrCount{,\option{/@ntcoveropts/status},}{,\option{/novathesis/docstatus},}[\@nt@instatus]%
    % \StrCount{,\option{/@ntcoveropts/degree},}{,\option{/@nt/document/docclass},}[\@nt@indegree]%
    % \typeout{OPT_DEGREE=[\option{/@ntcoveropts/degree}] DOCCLASS=[\option{/@nt/document/docclass}]}%
    % \typeout{OPT_STATUS=[\option{/@ntcoveropts/status}] STATUS=[\option{/novathesis/docstatus}]}\aaaaa
    \defifundef{\ifmatchstatus}{\newif}
    \defifundef{\ifmatchdegree}{\newif}
    \matchstatustrue
    \matchdegreetrue
    \if&\option{/@ntcoveropts/status}&\relax
    \else
      \if\instring{,\option{/novathesis/docstatus},}{,\option{/@ntcoveropts/status},}
      \else
        \matchstatusfalse
      \fi      
    \fi
    \if&\option{/@ntcoveropts/degree}&\relax
    \else
      \if\instring{,\option{/@nt/document/docclass},}{,\option{/@ntcoveropts/degree},}
      \else
        \matchdegreefalse
      \fi      
    \fi
    \ifmatchstatus
      \ifmatchdegree
        \@ntcoverelement@ii{#1}{#3}
      \fi
    \fi
     % \ifthenelse{%
     %          \(\equal{\option{/@ntcoveropts/status}}{}\OR\@nt@instatus>0\)\AND%
     %          \(\equal{\option{/@ntcoveropts/degree}}{}\OR\@nt@indegree>0\)}%
     %  {\@ntcoverelement@ii{#1}{#3}}%
     %  {}%
  }%
}

\options{/@ntcoveropts/.new family
  % titles for PDF bookmark / list of contents
  , bookmark/.new choice = {1-1=\thecoverbkmstring(\option{/novathesis/coverlang})
                          , 1-2={}
                          , 2-1=\thefrontpagebkmstring(\option{/novathesis/coverlang})
                          , 2-2={}
                          , N-1={}
                          , N-2=\thebackcoverbkmstring(\option{/novathesis/coverlang})
                          , spine=\thespinebkmstring(\option{/novathesis/coverlang})}
  % letter to macro for horizontal alignment
  , alignmap/.new choice={c=\centering,l=\raggedright,r=\raggedleft,j=\null}
  % filters / conditional printing
  , status/.new value
  , degree/.new value
  % horizontal alighment and vertical alignments inside the box
  , halign/.new choice={c, l, r, j}
  , valign/.new choice={c, t, b}
  % height of the box (default = the natural height for the contents)
  , height/.new value
  % height of the box (default = the natural height for the contents)
  , height/phd/.new value
  % height of the box (default = the natural height for the contents)
  , height/msc/.new value
  % minheight of the box (default = the natural height for the contents)
  , minheight/.new value
  % width of the box (default = full width)
  , width/.new value
  % vertical spacing from precious box (default = 0pt, can also be an integer and,
  % in this case, it means the weight of the vfill)
  , vspace/.new value
  % vertical spacing from precious box (default = 0pt, can also be an integer and,
  % in this case, it means the weight of the vfill)
  , vspace/phd/.new value
  % vertical spacing from precious box (default = 0pt, can also be an integer and,
  % in this case, it means the weight of the vfill)
  , vspace/msc/.new value
  % vertical spacing from precious box (default = 0pt, can also be an integer and,
  % in this case, it means the weight of the vfill)
  , vspace/1-1/.new value
  % vertical spacing from precious box (default = 0pt, can also be an integer and,
  % in this case, it means the weight of the vfill)
  , vspace/2-1/.new value
  % vertical spacing from precious box (default = 0pt, can also be an integer and,
  % in this case, it means the weight of the vfill)
  , vspace/phd/1-1/.new value
  % vertical spacing from precious box (default = 0pt, can also be an integer and,
  % in this case, it means the weight of the vfill)
  , vspace/phd/2-1/.new value
  % vertical spacing from precious box (default = 0pt, can also be an integer and,
  % in this case, it means the weight of the vfill)
  , vspace/msc/1-1/.new value
  % vertical spacing from precious box (default = 0pt, can also be an integer and,
  % in this case, it means the weight of the vfill)
  , vspace/msc/2-1/.new value
  % horizontal spacing from the left margin (or last box in the same line) (default = 0pt)
  , hspace/.new value
  % is the last box in the line (default = true)
  , newpar/.new toggle
  % text color for the box (default = black)
  , color/.new color
  % background color for the box (default = transparent)
  , bgcolor/.new color
  % default values
  , defaults/.new style*={
                  vspace=0pt, 
                  vspace/msc={}, vspace/phd={}, 
                  vspace/1-1={}, vspace/2-1={},
                  vspace/msc/1-1={}, vspace/msc/2-1={}, 
                  vspace/phd/1-1={}, vspace/phd/2-1={}, 
                  status={}, degree={}, halign=c, valign=c,
                  height={}, height/phd={}, height/msc={}, 
                  minheight=0pt, width={}, hspace=0pt, 
                  newpar=true, color={}, bgcolor={},
  }
  % set defaults
  , defaults
}

\newcommand{\@ntcovervspace}[1]{%
  \ifoptionvoid{/@ntcoveropts/#1}{%
    % \typeout{NT blank [#1=\option{/@ntcoveropts/#1}]}
  }{%
    % \typeout{NT notblank [#1=\option{/@ntcoveropts/#1}]}%
    \IfInteger{\option{/@ntcoveropts/#1}}% USE vspace
      {\vskip 0pt plus \option{/@ntcoveropts/#1}fill}%
      {\vspace*{\option{/@ntcoveropts/#1}}}%
    \ntforbreak
  }%
}
\newcommand{\@ntcoverelement@ii}[2]{%
  % #1 = cover ID (major-minor)
  % #2 = code
  % If vspace is integer then replace by n*\vfill
  % otherwise it is absolute verstical space
  % \typeout{NT testblank [#1] =========}%
  \ntfor\match:={vspace/\option{/novathesis/docdegree}/#1,vspace/\option{/novathesis/docdegree},vspace/#1,vspace}%
        \do{\@ntcovervspace{\match}}%
  % Typeset contents in a box
  \@nt@makeboxwithcoverelement@iii{#1}{#2}{\@nt@coverelement}%
  \noindent%
  \hspace*{\option{/@ntcoveropts/hspace}}%
  \ifoptioncontains{/novathesis/debug}{cover}{% If in debug mode surround element in box
    \setlength{\fboxsep}{0pt}\setlength{\fboxrule}{0.5pt}%
    \vspace*{-\fboxrule}\hspace*{-\fboxrule}%
    \fbox{\usebox{\@nt@coverelement}}%
  }{\usebox{\@nt@coverelement}}%
  \iftoggle{/@ntcoveropts/newpar}{\expandafter\par}{}%
}

\newcommand{\@nt@makeboxwithcoverelement@iii}[3]{%
  % #1 = cover ID (major-minor)
  % #2 = code
  % #3 = boxname
  \defifundef{\@mkcvelemwidth}{\newlength}%
  \ifoptionblank{/@ntcoveropts/width}%
    {\setlength{\@mkcvelemwidth}{\dimexpr\linewidth-\option{/@ntcoveropts/hspace}\relax}}%
    {\option{/@ntcoveropts/width}}%
  \ifoptionblank{/@ntcoveropts/height}%
    {}%
    {\edefoption{/@ntcoveropts/height}\@mkcvelemheight}%
  % Create destination boxes if undefined and save to it
  \defifundef{#3}{\newsavebox}%
  \begin{lrbox}{#3}%
    \begin{minipage}[t][0pt][t]{0pt}%
      \color{blue}\rule{0.000000000000001pt}{\option{/@ntcoveropts/minheight}}%
    \end{minipage}
    % Minipage definition is different if element height is given or not
    \ifoptionblank{/@ntcoveropts/height}%
        {\minipage[t][][\option{/@ntcoveropts/valign}]{\@mkcvelemwidth}}%
        {\minipage[t][\@mkcvelemheight][\option{/@ntcoveropts/valign}]{\@mkcvelemwidth}}%
            \ifoptionblank{/@ntcoveropts/color}{}{\color{\option{/@ntcoveropts/color}}}%
            \option{/@ntcoveropts/alignmap}%
            #2%
        \endminipage%
  \end{lrbox}%
  \begin{lrbox}{#3}%
    % Add background color if necessary
    \ifoptionblank{/@ntcoveropts/bgcolor}%
      {\usebox{#3}}%
      {\colorbox{\option{/@ntcoveropts/bgcolor}}{\usebox{#2}}}%
  \end{lrbox}%
}

\newcommand{\@ntfixspacing}[2]{%
		\bgroup%
    \newdata{ntfixspacingstring}
    \ntfixspacingstring()={This document was created with the (pdf/Xe/Lua)\LaTeX\ processor and the \href{https://github.com/joaomlourenco/novathesis}{NOVAthesis} template (v\novathesisversion)~\@ntcite{novathesis-manual}.}
		\renewcommand*{\bibfont}{\hypersetup{allcolors=#1}\color{#1}%
		 \sffamily\fontsize{#2}{#2}\selectfont}%
		\defbibheading{bibliography}[\bibname]{%
		\ \textbf{##1}\\[-20pt]}
		\refsection%
		\begin{minipage}{\linewidth}%
		\bibfont%
		\thentfixspacingstring()%
		\printbibliography[title=12cc90221730b8ba41bb3b1f8b517acd]%
		\end{minipage}%
		\endrefsection%
		\egroup%
}

\newcommand{\ntfixspacing}{%
  \@ntfixspacing{white}{0.01}%
  % \@ntfixspacing{blue}{16}%
}

\newcommand*{\ntprintstatement}{%
  \iftoggle{/novathesis/statement}{% if statement toggle is on
    \ifmaindoc{%
      \NTRunHook{statement/pre}%
      \iffileadded{statement}{}{%ELSE
        \ntfor\match:={%
          \@nt@schl/statement-\option{/novathesis/degreeacr/\option{/@nt/document/docclass}}%
          -\option{/novathesis/mainlang},%
          \@nt@schl/statement-\option{/novathesis/degreeacr/\option{/@nt/document/docclass}},%
          \@nt@schl/statement-\option{/novathesis/mainlang},%
          \@nt@schl/statement,%
          statement-\option{/novathesis/mainlang},%
          statement%
        }\do{%
          \IfFileExists{NOVAthesisFiles/Schools/\@nt@univ/\match.tex}{%
            \ntaddfile{statement}{NOVAthesisFiles/Schools/\@nt@univ/\match.tex}%
            \ntforbreak%
          }{}%
        }[%
          \ClassError{novathesis}{No “statement.tex” found! Not defined with %
                                  \string\ntaddfile{statement}{filename} in folders %
                                  “NOVAthesisFiles/Schools/\@nt@univ/\@nt@schl” nor %
                                  “NOVAthesisFiles/Schools/\@nt@univ”}{}
        ]%
      }{}%
      \ntselectlang{\option{/novathesis/mainlang}}%
      \pdfbookmark[1]{\csuse{thestatementbkmstring}(\option{/novathesis/mainlang})}{bmstatement}%
      \@ntloadfiles@ii{statement}%
      \NTRunHook{statement/post}%
    }{}%
  }{}%
}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Print persons list {advisers | committee}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\ntprintpersons}[5][full]{%
  % #1 = { full | name | list }
  % #2 = width in % of textwidth
  % #3 = number of columns
  % #4 = adviser | committee
  % #5 = {a,c} | {c,r,a,m,g}
  % \typeout{NTPRINTPERSONS 1=[#1] 2=[#2] 3=[#3] 4=[#4] 5=[#5]}\aaa
  \iftoggle{/novathesis/print#4}{%
    \IfStrEqCase{#3}{%
      {0}{\@ntprintpersonsaslist{#4}{#5}}%
      {1}{\@ntprintpersonsasonecolumn{#1}{#2}{#4}{#5}}%
      {2}{\@ntprintpersonsastwocolumns{#1}{#2}{#4}{#5}}%
    }[\ClassError{novathesis}{Ivalid argument [#3] to \string\ntprintpersons{#1}{#2}{#3}{#4}{#5}}{}]%
  }{}%
}

%============================================================
% Print persons list {advisers | committee} as list
%============================================================
\newcommand{\@ntprintpersonsaslist}[2]{%
  % #1 = adviser | committee
  % #2 = {a,c} | {c,r,a,m,g}
  % Build list of names
  \ifdatadefined{#1titlestring}(\option{/novathesis/coverlang}){%
    \datadefault{#1titlestringpre}()%
    \datadefault{#1titlestringfont}()%
    \csuse{the#1titlestring}(\option{/novathesis/coverlang})%
    \datadefault{#1titlestringpost}()%
  }{}%
  \def\@nt@personlist{}%
  \def\@nt@listsep{}%
  \@for\i:=\expanded{#2}\do{%
    \ifoptionvoid{/@nt/#1/\i/name}{}{%
      \letoptionlist{/@nt/#1/\i/name}\@nt@person@sublist%
      \eappto\@nt@personlist{\@nt@listsep\@nt@person@sublist}\edef\@nt@listsep{,}%
    }%
  }%
  \@replacelastcomma{\@nt@personlist}%
}

\def\@replacelastcomma#1{%
  % \typeout{REP1 [#1]}%
	% \@replacelastcomma@i{}{}#1,\nil}
	\expandafter\@replacelastcomma@i\expandafter{\expandafter}\expandafter{\expandafter}#1,\nil}

\def\@replacelastcomma@i#1#2#3,#4\nil{%
  % \typeout{REP2 [#1] [#2] [#3] [#4]}%
	\if\relax\detokenize{#4}\relax
		#2\trimspaces{#3}%
	\else % #4 is not empty
		#1\trimspaces{#3}%
		\@replacelastcomma@i{\thecommastring(\option{/@nt/currentlang})}%
        {\theandstring(\option{/@nt/currentlang})}#4\nil%
	\fi
}



%============================================================
% Print persons list {advisers | committee} as one and two columns
%============================================================
\newcommand{\@ntprintpersonsasonecolumn}[4]{%
  % #1 = { full | name | list }
  % #2 = width in % of textwidth
  % #3 = adviser | committee
  % #4 = {a,c} | {c,r,a,m,g}
  \csuse{#3stringpost}():={:\\[2pt]}%
  \csuse{#3remainderpre}()={{\\}}%
  \personpost()={\\[4pt]}%
  \persongrouppost()={\\[-4pt]}
  \begin{tabularx}{#2\linewidth}[t]{@{}X@{}}%
    \expandnext{\forcsvlist{\@nt@ntprintpersongroup[#1]{1}{#3}}}{\expanded{#4}}%
    % \@for\arg:=\expanded{#4}\do{\@nt@ntprintpersongroup{#1}{1}{#3}{\arg}}
  \end{tabularx}%
}

\newcommand{\@ntprintpersonsastwocolumns}[4]{%
  % #1 = { full | name | list }
  % #2 = width in % of textwidth
  % #3 = adviser | committee
  % #4 = {a,c} | {c,r,a,m,g}
  % \typeout{NTPRINTPERSONSASTWOCOLUMNS 1=[#1] 2=[#2] 3=[#3] 4=[#4]}%\aaa
  \csuse{#3stringpost}():={:&}%
  \csuse{#3remainderpre}()={{\\}}%
  \personpost()={\\[4pt]}%
  \persongrouppost()={\\[-6pt]}
  \committeetitlestringpre()={&}%
  \committeetitlestringpost()={\\[7pt]}%
  \begin{tabularx}{#2\linewidth}[t]{@{}r@{~~}>{\raggedright\arraybackslash}X@{}}%
    \ifdatadefined{#3titlestring}(\option{/novathesis/coverlang}){%
      \datadefault{#3titlestringpre}()%
      \datadefault{#3titlestringfont}()%
      \csuse{the#3titlestring}(\option{/novathesis/coverlang})%
      \datadefault{#3titlestringpost}()%
    }{}%
    \expandnext{\forcsvlist{\@nt@ntprintpersongroup[#1]{2}{#3}}}{\expanded{#4}}%
    % \@for\i:=\expanded{#4}\do{\typeout{NTPRINTIIIII=\i}\@nt@ntprintpersongroup[#1]{2}{#3}{\i}}%
    % \foreach \i [expand list=true] in {#4} {\@nt@ntprintpersongroup{#1}{2}{#3}{\i}}%
  \end{tabularx}%
}

\newcommand{\@nt@ntprintpersongroup}[4][full]{%
  % #1 = { full | name | list }
  % #2 = {1 | 2}
  % #3 = {adviser | committee}
  % #4 = {a,c} | {c,r,a,m,g}
  \ifoptiondefined{/@nt/#3/#4/full}{%
  % \typeout{NTPRINTPERSONGROUP 1=[#1] 2=[#2] 3=[#3] 4=[#4]}%\aaa
    \@nt@reducegender{/@nt/#3/#4/gender}{\@nt@advgender}%
    \@nt@reducenumber{/@nt/#3/#4/full}{\@nt@advnumber}%
    \datadefault{#3stringpre}(#4)%
    \bgroup%
      \datadefault{#3stringfont}(#4)%
      \datadefault{#3string}(#4,\@nt@advnumber,\@nt@advgender,\option{/novathesis/coverlang})%
    \egroup%
    \datadefault{#3stringpost}(#4)%
    % \if#22\relax&\fi
    % \IfStrEq{#2}{2}{&}{}%
    \IfStrEq{#1}{list}{%
      \@ntprintpersonsaslist{#3}{#4}%
    }{%
      \begin{minipage}[t]{\linewidth}%
          \optionlistdo{/@nt/#3/#4/full}{\@nt@printonename{#1}{#3}{##1}}%
      \end{minipage}%
    }%
    \thepersongrouppost()%
  }{}%
}


%============================================================
% Print person aux funcitons
%============================================================
\newcommand{\@nt@printonename}[3]{%
% #1 = { full | name }
% #2 = adviser | coadviser | committee
% #3 = (co)adviser info
% \typeout{NTPRINTONENAME 1=[#1] 2=[#2] 3=[#3]}%\bbb
\begingroup
  \raggedright%
  \StrCut{#3}{,}\@nt@name\@nt@remainder% split name from remainder
  \csuse{the#2namepre}()%
  \bgroup%
    \csuse{the#2namefont}()%
    \ignorespaces\@nt@name%
  \egroup%
  \csuse{the#2namepost}()%
  \IfStrEq{#1}{full}{%
    \IfStrEq{\@nt@remainder}{}{}{%
      \csuse{the#2remainderpre}()%
      \bgroup%
        \csuse{the#2remainderfont}()%
        \ignorespaces\raggedright\@nt@remainder%
      \egroup%
      \csuse{the#2remainderpost}()%
    }%
  }{}%
\endgroup
\thepersonpost()%
}

\newcommand*{\@nt@reducegender}[2]{%
		% #1=gender list
		% #2=result
		\gdef#2{f}%
		\optionlistdo{#1}{\if##1m\relax\gdef#2{m}\fi}%
}

\newcommand*{\@nt@reducenumber}[2]{%
		% #1=options list
		% #2=result (1|2)
		\ifnum\value{\option{#1/@size}}=1\gdef#2{1}\else\gdef#2{2}\fi
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% PAGE LAYOUT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\AtEndPreamble{\ntsetlayout}%

\newcommand*{\ntsetlayout}{%
		% \synctex=1% Use synctex
		\brokenpenalty=10000%
		\settypeoutlayoutunit{mm}%
		\setulmarginsandblock%
		{\themargin(\option{/novathesis/media},top)}%
		{\themargin(\option{/novathesis/media},bottom)}%
		{*}%
		\setlrmarginsandblock%
		{\themargin(\option{/novathesis/media},left)}%
		{\themargin(\option{/novathesis/media},right)}%
		{*}%
		\checkandfixthelayout%
		\ifoptionequal{/novathesis/media}{paper}{\openright}{}%
}

\newenvironment{newlayout}[2]{%
  \clearpage%
  % \typeout{V=#1 H=#2}\aaaa
  \@tempdima=\dimexpr#1\relax%
  \@tempdimb=\dimexpr#2\relax%
  % \showthe\@tempdima \showthe\@tempdimb
  \setstocksize{\the\@tempdima}{\the\@tempdimb}%
  \settrimmedsize{\stockheight}{\stockwidth}{*}%
  \settrims{0pt}{0pt}%
  \setlrmarginsandblock{0pt}{*}{*}%
  \setulmarginsandblock{0pt}{*}{*}%
  \setlength{\parskip}{0pt}%
  \setheadfoot{0pt}{0pt}%
  \setheaderspaces{*}{0pt}{*} %
  \setmarginnotes{0pt}{0pt}{0pt}%
  \checkandfixthelayout[fixed]%
  %
  %
  % \settrimmedsize{#2}{#1}{*}%
  % \settrims{0pt}{0pt}
  % \setlrmarginsandblock{0pt}{0pt}{*}%
  % \setulmarginsandblock{0pt}{*}{1}%
  % \setheadfoot{0pt}{0pt}%
  % \setheaderspaces{0pt}{*}{*}%
  % \checkandfixthelayout%
  \ifluatex%
    \pageheight=\stockheight% \pageheight=3in
    \pagewidth=\stockwidth% \pageheight=3in
  \else%
    \pdfpageheight=\stockwidth% \pdfpageheight=3in
    \pdfpagewidth=\stockheight% \pdfpageheight=3in
  \fi%
  \setlength{\@colht}{\textheight}%
  \setlength{\@colroom}{\textheight}%
  \setlength{\vsize}{\textheight}%
  \setlength{\columnwidth}{\textwidth}%
  \if@twocolumn%
    \advance\columnwidth-\columnsep%
    \divide\columnwidth\tw@%
    \@firstcolumntrue%
  \fi%
  \setlength{\hsize}{\columnwidth}%
  \setlength{\linewidth}{\hsize}%
}{%
  \clearpage%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Printing chapters and similars
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\@nt@printifmaindoc@i}[1]{%
  % \typeout{NT Attempt to load #1}%
	\ifmaindoc{% THEN it is a main document
		\NTRunHook{#1/pre}%
		\iffileadded{#1}{%
		\ntselectlang{\option{/novathesis/mainlang}}%
		\pdfbookmark[1]{\csuse{the#1bkmstring}(\option{/novathesis/mainlang})}{bm#1}%
		\@ntloadfiles@ii{#1}%
		}{}%
		\NTRunHook{#1/post}%
	}{}% It is a plan or proposal type document
}

\newcommand{\ntprintdedicatory}{\@nt@printifmaindoc@i{dedicatory}}

\newcommand{\ntprintquote}{\@nt@printifmaindoc@i{quote}}

\newcommand{\ntprintacknowledgements}{\@nt@printifmaindoc@i{acknowledgements}}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%% Abstract, Acronyms and Glossary
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\ntprintabstracts}{%
		\@for\listitem:=\expanded{%
		\theabstractorder(\option{/novathesis/mainlang})}\do{\@ntprintabstract{\listitem}}%
		\ntselectlang{\option{/novathesis/mainlang}}%
}

\newcommand{\@ntprintabstract}[1]{%
  % \typeout{NT PRINT ABSTRACT #1}\aaaa%
	\iffileadded[#1]{abstract}{%
    % \begingroup
    % \typeout{NT PRINT ABSTRACT #1}\bbbb
		\ntselectlang{#1}%
		\pdfbookmark[1]{\theabstractbkmstring(#1)}{bmabstract#1}%
		\NTRunHook{abstract/pre}%
		\NTRunHook{abstract/#1/pre}%
		\printabstracttitle{#1}%
		\NTRunHook{abstract/#1/mid}%
		\NTRunHook{abstract/mid}%
		\@ntloadfiles@ii[#1]{abstract}%
		\NTRunHook{abstract/#1/post}%
		\NTRunHook{abstract/post}%
    % \endgroup
	}{}%
}

\newcommand{\ntprintindex}{%
  % \printglossary[type=index]%
  \printindex
}


\newcommand*{\ntthesisfrontmatter}{%
	\NTRunHook{frontmatter/pre}%
	\frontmatter%
	\begingroup
	\pagestyle{novathesis@frontmatter}%
	\copypagestyle{chapter}{novathesis@frontmatter}
	\ntselectlang{\option{/novathesis/mainlang}}%
	\pagenumbering{roman}%
	\NTRunHook{frontmatter/post}%
}

\newcommand*{\ntthesismainmatter}{%
	\endgroup
	\bookmarksetup{startatroot}%
	\NTRunHook{mainmatter/pre}%
  % \ifbool{@openright}{}{% openany=true
  %   \let\oldcleardoublepage\cleardoublepage%
  %   \renewcommand{\cleardoublepage}{\clearforchapter}%
  % }%
	\mainmatter%
  % \ifbool{@openright}{}{% openany=true
  %   \let\cleardoublepage\oldcleardoublepage%
  % }%
	\pagestyle{novathesis@mainmatter}%
	\ifxeorlua{}{\microtypesetup{protrusion=true}}%
	\NTRunHook{mainmatter/post}%
}

\newcommand{\ntindex}[2][]{%
  % \typeout{NTINDEX [#1] [#2]}
  \bgroup%
    \ifoptioncontains{/novathesis/debug}{index}{\showlabelsinline}{}%
    \StrRight{#1}{1}[\@nt@index]%
    \if\@nt@index!\relax
      \def\@nt@index{#1#2}%
    \else
      \def\@nt@index{#1}%
    \fi%
    \index{\@nt@index}#2%
    % \ifoptioncontains{/novathesis/debug}{index}{}%
    %                                            {\def\@nt@index{f}}%
    % \if\@nt@index t\relax
    %   \marginpar{#1#2}%
    % \fi%
  \egroup%
}

% \newcommand{\ntindex}[2][]{%
%   \if\relax\detokenize{#1}\relax
%     \index{#2}#2%
%   \else
%     \index{#1}#2%
%   \fi%
% }


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapters
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\ntchapterfile}[1]{\listgadd{\@nt@chapter@list}{#1}}

\newcommand*{\ntprintchapters}{%
		\@nt@foralllist{file}{chapter}{\@ntloadfiles@ii{chapter}}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Appendixes and Annexes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand*{\addappheadtotoc}{%
		\phantomsection\addtocontents{toc}%
		{\protect\contentsline{chapter}{\appendixtocname}{}{}}%
 }

\newcommand*{\ntprintappendices}{%
	\iffileadded{appendix}{%
		\renewcommand{\appendixtocname}{\appendixnamepl}%
		\appendix\addappheadtotoc%
		\@nt@foralllist{file}{appendix}{\@ntloadfiles@ii{appendix}}%
	}{}%
}

\newcommand*{\ntprintannexes}{%
  \iffileadded{annex}{%
    \renewcommand{\appendixtocname}{\annexnamepl}%
    \annex\addappheadtotoc%
    \@nt@foralllist{file}{annex}{\@ntloadfiles@ii{annex}}%
  }{}%
}

\ifdef{\annexcounter}{}{\def\annexcounter{\old@Roman}}
\newcommand*{\annex}{%
  \xdef\Hy@chapapp{annex}%
  \setcounter{chapter}{0}%
  \setcounter{section}{0}%
  \gdef\@chapapp{\annexname}%
  \gdef\thechapter{\annexcounter\c@chapter}%
}%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Deal with optional lists in the frontmatter: listoftables, litoffigures, etc.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\ntprintalllistof}{%
		\NTRunHook{listof/pre}%
		\optionlistdo{/@nt/list/listof}{##1\clearforchapter}%
		\NTRunHook{listof/post}%
}


% \def\option@listmatch@getval#1=#2{#2}
\newcommand*{\option@listmatch}[2]{
		% \typeout{NT LISTMATCH [#1] [#2]}%
		\StrCut{#2}{=}\option@listmatch@key\option@listmatch@value%was xStrCut
		% \typeout{K=\option@listmatch@key ~V=\option@listmatch@value}%
		\IfStrEq{#1}{\option@listmatch@key}{\listbreak}{}%
}%
\options{/handlers/getval/.new operation={%
		% \typeout{NT GETVAL [#1] [#2]}%
		\optionlistdo{#1}{\option@listmatch{#2}{##1}}%
		}%
}

\newcommand*{\@loadglossaryfiles}{%
	\@for\listitem:={glossary,acronyms,symbols}\do{%
		\iffileadded[\listitem]{glossaries}{\@nt@loadallfiles{\listitem}{glossaries}}{}%
	}%
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Bibliography
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand*{\ntprintbib}[1][]{%
  \NTRunHook{printbib/pre}%
  \printbibliography[#1]%
  \ntfixspacing%
  \NTRunHook{printbib/post}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Copyright page
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\ntprintacknowledgementsblock}[1][\scriptsize]{%
		\NTRunHook{acknowledgementsblock/pre}%
		\noindent\parbox{\linewidth}{%
		\vspace*{2.5ex}\footnoterule#1\theacknowledgmentsstring(\option{/novathesis/mainlang})}
		\NTRunHook{acknowledgementsblock/post}%
}

\newcommand*{\ntprintcopyright}{%
		\iftoggle{/novathesis/printcopyright}{%
		\ifmaindoc{%
		\ntselectlang{\option{/novathesis/copyrightlang}}%
		\pdfbookmark[1]{\csuse{thecopyrightbkmstring}(\option{/novathesis/mainlang})}{bmcopyright}%
		\NTRunHook{copyright/pre}%
		\ntprintcopyrightpage%
		\NTRunHook{copyright/post}%
		\ntprintacknowledgementsblock%
		}{}%
		}{}%
}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Dedicatory
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newenvironment{ntdedicatory}[1][100mm]{%
		\begin{ntquoting}[#1]{dedicatory}
}{\end{ntquoting}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Quote
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newenvironment{ntquote}[1][100mm]{%
		\begin{ntquoting}[#1]{quote}
}{\end{ntquoting}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Quoting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Author in a line by otself

\newcommand{\hugequote}{%
  \bgroup%
    \color{black!30}%
    \fontsize{75}{80}\selectfont%
    \fontfamily{ptm}\selectfont%
    \textit{\glqq}%
  \egroup%
}

\newenvironment{ntquoting}[2][10cm]{%
  \bgroup
    \iftoggle{/novathesis/numberallpages}%
      {\thispagestyle{novathesis@frontmatter}}%
      {\thispagestyle{empty}}%
    \gdef\@ntquoting{#2}
    \renewcommand*{\mkcitation}[1]{\\[0.5ex]--- ##1}
    \vspace*{\beforechapskip}%
    \NTRunHook{\@ntquoting/pre}%
    \minipage[t]{\linewidth}%
    \raggedleft%
    \ifstrequal{#2}{quote}{\hugequote}{}%
    \minipage[t]{#1}%
    \raggedleft\normalsize\itshape%
}{%
    \normalfont%
    \endminipage%
    \endminipage%
    \NTRunHook{\@ntquoting/post}%
  \egroup
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Acknowledgements
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newenvironment{ntacknowledgements}{%
		\chapter*{\theacknowledgementsbkmstring(\option{/novathesis/mainlang})}%
}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Abstract
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\printabstracttitle}[1]{%
	\chapter*{\theabstractbkmstring(#1)}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Keywords
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\providecommand{\keywords}[1]{%
		\NTRunHook{keywords/pre}%
		% \NTRunHook{keywords/#1/pre}%
		\def\and{\unskip\datadefault{keywordssep}(\option{/@nt/currentlang})}%
		% \def\and{{\textperiodcentered} }%
		\par\addvspace\baselineskip\noindent%
		\begingroup
		\datadefault{keywordsstringprefix}(\option{/@nt/currentlang})%
		\datadefault{keywordsstringfont}(\option{/@nt/currentlang})%
		\csuse{thekeywordsstring}(\option{/@nt/currentlang})%
		\datadefault{keywordsstringsuffix}(\option{/@nt/currentlang})%
		\endgroup
		% \enspace
		\ignorespaces#1%
		% \NTRunHook{keywords/#1/post}%
		\NTRunHook{keywords/post}%\
}%
		


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% LABELS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\providecommand\thepresentationtext{%
		\thedissertationstringfont()%
		\ifdatadefined{issertationstring}(\option{/novathesis/docdegree},\option{/novathesis/coverlang}){%
		\thedissertationstring(\option{/novathesis/docdegree},\option{/novathesis/coverlang})%
		}{%
		\thedissertationstring(\option{/@nt/document/docclass},\option{/novathesis/coverlang})%
		}
}

\providecommand\thecopyrightstr{%
		\iftoggle{/novathesis/numberallpages}%
		 {\thispagestyle{novathesis@frontmatter}}%
		 {\thispagestyle{empty}}%
		\noindent%
		Copyright \textcopyright\ \thedocauthor(name), %
		\theschool(\option{/novathesis/copyrightlang}), \theuniversity(\option{/novathesis/copyrightlang}).\\%
		\thecopyrighttextstring(\option{/novathesis/copyrightlang})%
		\ntselectlang{\option{/novathesis/mainlang}}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Table of contents
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setcounter{tocdepth}{2}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Sectioning
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\maxsecnumdepth{subsubsection}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fixes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Fix spacing for pages with roman numerals in ToC
\renewcommand*{\@pnumwidth}{2.5em}% default is 1.55em


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Text style
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifcsdef{chs@\option{/novathesis/chapstyle}}{%
  \chapterstyle{\option{/novathesis/chapstyle}}%
}{%
  \InputIfFileExists{NOVAthesisFiles/ChapStyles/\option{/novathesis/chapstyle}.ldf}{}{%
  		\ClassError{novathesis}{Invalid Chapter Style: \option{/novathesis/chapstyle}}{}%
  }%
}
\InputIfFileExists{NOVAthesisFiles/FontStyles/\option{/novathesis/fontstyle}.ldf}{}{%
		\ClassError{novathesis}{Invalid Font Style: \option{/novathesis/fontstyle}}{}%
}

\ifxeorlua{\definecolor{nearlywhite}{gray}{0.999999}\colorlet{white}{nearlywhite}}{}

\AtBeginDocument{%
  \makeatletter%
  % \typeout{XXX [\thedocauthor(name)]}
  % \typeout{XXX [\thedoctitle(\option{/novathesis/mainlang},main)]}
  % \typeout{XXX [\thedoctitle(\option{/novathesis/mainlang},sub)]}
	\hypersetup{%
		pdfauthor={\thedocauthor(name)},
		pdftitle={\thedoctitle(\option{/novathesis/mainlang},main)},
		pdfsubject={\thedoctitle(\option{/novathesis/mainlang},sub)},
  }

	%--------------------------------
	% If subcaptin is laoded, let it hand handle subfigures
	% otherwise use memoir subfigures
	\@ifpackageloaded{subcaption}{}{\newsubfloat{figure}}
	\newcommand{\@ntcite}[1]{\ifdef{\parencite}{\parencite{#1}}{\cite{#1}}}
	\makeatother
}
